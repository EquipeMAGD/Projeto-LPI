#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
#include <conio.h>
#include <dos.h>

int menu()
{
        int operacao;
        char c;
        while(operacao!=1){
        printf("\t\t  Pacman!\n \t\tEquipe MAGD\n");
        printf("1\t--Jogar\n2\t--Ajuda\n3\t--Pontuacoes\n4\t--Sair\n\n");
        scanf("%d",&operacao);
        switch( operacao )
        {
            case 1:
                printf("vc pressionou jogar\npressione qualquer tecla para continuar...");
                c=getch();
                break;
            case 2:
                printf("para jogar, escolha a opcao de numero 1 no menu\npara movimentar o personagem, use as teclas direcionais\n-->\"w\" para subir,\n-->\"a\" para esquerda,\n-->\"s\" para descer e\n-->\"d\" para direita\n");
                printf("para consultar a pontuacao, escolha a opcao de numero 3 no menu\npara sair, escolha a opcao de numero 4 no menu\n");
                printf("\npressione qualquer tecla para continuar...");
                c = getch();
                break;
            case 3:
                //fopen();
                break;
            case 4:
                printf("vc escolheu sair");
                exit(0);
            default:
                printf("Vc escolheu uma operacao invalida.");
                printf("pressione qualquer tecla para continuar...");
                c=getch();
        }
        system ("cls");
        }
}



typedef struct coord
{
    int x, y;
} coord;

void barreira(int *x, int *y,int antgx,int antgy,int barra[31][28])
{
    if(barra[*x][*y]==1)
    {
        *x=antgx;
        *y=antgy;
    }
    if(*y==27) *y=0;
    else if(*y==0) *y=27;
}

void direcao(int *x, int *y)
{
    static char c;
    if(kbhit()) c=getch();
    switch(c)
    {
    case 'w':
        *x-=1;
        break;
    case 's':
        *x+=1;
        break;
    case 'a':
        *y-=1;
        break;
    case 'd':
        *y+=1;
        break;
    }
}

void dirrand(int *x, int *y)
{
    int n;
    static int cont=0;
    cont++;
    if(cont>12) n=rand()%4;
    else n=0;
    switch(n)
    {
    case 0:
        *x-=1;
        break;
    case 1:
        *x+=1;
        break;
    case 2:
        *y-=1;
        break;
    case 3:
        *y+=1;
        break;
    }
}

void GAMEOVER(int ponto)
{
    char nome[20];
    char rp;

    system("cls");
    printf("\n\n\n\n\n\t\t\tGAME OVER\n\n\n\t\tPrecione qualquer tecla...\n\n");
    getch();

    FILE *file;
    file = fopen("ranking.txt","a");
    printf("\tDigite seu nome..\n\t");
    gets(nome);
    fputs(nome,file);
    fprintf(file," ---  %i", ponto);
    fputc('\n',file);
    fclose(file);
    system("cls");
    printf("\nJOGAR NOVAMENTE?\n");
    rp = getche();

    if(rp=='s' || rp=='S')main();
    else exit(1);
}

void barreirafant(int *x, int *y,int antgx,int antgy,int barra[31][28])
{
    system("color 01");
    do
    {
        if(barra[*x][*y]==1)
        {
            *x=antgx;
            *y=antgy;
            dirrand(x,y);
        }
        if(*y==27) *y=0;
        else if(*y==0) *y=27;
    }
    while(barra[*x][*y]==1);
}

main()
{
    menu();
    int matriz[31][28];
    char c;
    char b[31][29],*a[31];

    int i, j,pis=1, t=50,aux[4],auxy[4], ponto=0, barra[31][28];
    coord pm, fant[3];

    //DEFINIÇÃO DE COORDENADAS INICIAIS
    pm.x=17;
    pm.y=14;
    for(i=0; i<3; i++)
    {
        fant[i].x=15;
        fant[i].y=14;
    }

    for(i=0; i<31; i++) a[i]=b[i];
    a[0] ="311111111111MAGD111111111114";
    a[1] ="2            bb            2";
    a[2] ="2 caad caaad bb caaad caad 2";
    a[3] ="2 b00b b000b bb b000b b00b 2";
    a[4] ="2 faae faaae fe faaae faae 2";
    a[5] ="2                          2";
    a[6] ="2 caad cd caaaaaad cd caad 2";
    a[7] ="2 faae bb faadcaae bb faae 2";
    a[8] ="2      bb    bb    bb      2";
    a[9] ="611114 bfaad bb caaeb 311115";
    a[10]="000002 bcaae fe faadb 200000";
    a[11]="000002 bb          bb 200000";
    a[12]="000002 bb 31100114 bb 200000";
    a[13]="111115 fe 20000002 fe 611111";
    a[14]="0         20000002         0";
    a[15]="111114 cd 20000002 cd 311111";
    a[16]="000002 bb 61111115 bb 200000";
    a[17]="000002 bb          bb 200000";
    a[18]="000002 bb caaaaaad bb 200000";
    a[19]="311115 fe faadcaae fe 611114";
    a[20]="2            bb            2";
    a[21]="2 caad caaad bb caaad caad 2";
    a[22]="2 fadb faaae fe faaae bcae 2";
    a[23]="2   bb                bb   2";
    a[24]="714 bb cd caaaaaad cd bb 319";
    a[25]="715 fe bb faadcaae bb fe 619";
    a[26]="2      bb    bb    bb      2";
    a[27]="2 caaaaefaad bb caaefaaaad 2";
    a[28]="2 faaaaaaaae fe faaaaaaaae 2";
    a[29]="2                          2";
    a[30]="6111111111111111111111111115";

    //DEFINIÇÃO DAS BARREIRAS
    for(i=0; i<31; i++)
    {
        for(j=0; j<28; j++)
        {
            barra[i][j]=0;
            switch(a[i][j])
            {
            //Duas linhas
            case '1': matriz[i][j]=205; break;
            case '2': matriz[i][j]=186; break;
            case '3': matriz[i][j]=201; break;//Quinas
            case '4': matriz[i][j]=187; break;
            case '5': matriz[i][j]=188; break;
            case '6': matriz[i][j]=200; break;
            case '7': matriz[i][j]=204; break;
            case '8': matriz[i][j]=203; break;
            case '9': matriz[i][j]=185; break;

            //Uma linha
            case 'a': matriz[i][j]=196; break;
            case 'b': matriz[i][j]=179; break;
            case 'c': matriz[i][j]=218; break;
            case 'd': matriz[i][j]=191; break;
            case 'e': matriz[i][j]=217; break;
            case 'f': matriz[i][j]=192; break;

            //NOME
            case 'M': matriz[i][j]='M'; break;
            case 'A': matriz[i][j]='A'; break;
            case 'G': matriz[i][j]='G'; break;
            case 'D': matriz[i][j]='D'; break;

            case ' ': matriz[i][j]=250; break;
            case '0': matriz[i][j]=' '; break;
            }
            /*/
            if((a[i][j])=='1') matriz[i][j]=219;
            else if(a[i][j]=='#')matriz[i][j]=250;
            else matriz[i][j]=' ';
            /*/
            if(matriz[i][j]!=250 && matriz[i][j]!=' ') barra[i][j]=1;
        }
    }

    while(1)
    {
        system("cls");

        for(i=0; i<3; i++)
        {
            auxy[i]=fant[i].y;
            aux[i]=fant[i].x;
            dirrand(&fant[i].x, &fant[i].y);
            barreirafant(&fant[i].x,&fant[i].y,aux[i],auxy[i],barra);
            if(fant[i].x==pm.x && fant[i].y==pm.y)
            {
                GAMEOVER(ponto);
            }
        }

        auxy[3]=pm.y;
        aux[3]=pm.x;
        direcao(&pm.x, &pm.y);
        barreira(&pm.x,&pm.y,aux[3],auxy[3],barra);

        printf("Pontuacao: %d\n", ponto);
        for(i=0; i<31; i++)
        {
            for(j=0; j<28; j++)
            {

                if( matriz[i][j]==250 && i==pm.x && j==pm.y)
                {
                    ponto++;
                    matriz[i][j]=' ';
                    if(pis%2==0) putchar('C');
                    else putchar('O');
                }
                else if( matriz[i][j]==' ' && i==pm.x && j==pm.y)
                {
                    if(pis%2==0) putchar('C');
                    else putchar('O');
                }
                else if(i==fant[0].x && j==fant[0].y) putchar(182); //fantasma
                else if(i==fant[1].x && j==fant[1].y) putchar(182); //fantasma
                else if(i==fant[2].x && j==fant[2].y) putchar(182); //fantasma
                else printf("%c", matriz[i][j]);
            }
            putchar('\n');
        }
        for(i=0; i<3; i++)
        {
            if(fant[i].x==pm.x && fant[i].y==pm.y)
            {
                GAMEOVER(ponto);
            }
        }
        Sleep(250);
        pis++;
    }
}
