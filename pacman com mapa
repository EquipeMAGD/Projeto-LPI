#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
#include <conio.h>
#include <dos.h>



typedef struct coord
{
    int x, y;
} coord;

void barreira(int *x, int *y,int antgx,int antgy,int barra[21][31])
{
    if(barra[*x][*y]==1) {*x=antgx;*y=antgy;}
    if(*y==30) *y=0;
    else if(*y==0) *y=30;
    if(*x==0) *x=20;
    else if(*x==20) *x=0;
}

void direcao(int *x, int *y)
{
    static char c;
    if(kbhit()) c=getch();
    switch(c)
    {
    case 'w':
        *x-=1;
        break;
    case 's':
        *x+=1;
        break;
    case 'a':
        *y-=1;
        break;
    case 'd':
        *y+=1;
        break;
    }
}

void dirrand(int *x, int *y)
{
    int n;
    static int cont=0;
    cont++;
    if(cont>3) n=rand()%4;
    else n=0;
    switch(n)
    {
    case 0:
        *x-=1;
        break;
    case 1:
        *x+=1;
        break;
    case 2:
        *y-=1;
        break;
    case 3:
        *y+=1;
        break;
    }
}

void arquivos(){
     char nome[20]; char rp;
    FILE *file;
    file = fopen("ranking.txt","a");
    printf("\tDigite seu nome..\n\t");
    gets(nome);
    fputs(nome,file);
    fputc('\n',file);
    fclose(file);
    system("cls");
    printf("\nJOGAR NOVAMENTE?\n");
    rp = getche();
    if(rp=='s' || rp=='S');
    else return 0;
    }


void GAMEOVER(void)
{
    system("cls");
    printf("\n\n\n\n\n\t\t\tGAME OVER\n\n\n\t\tPrecione qualquer tecla...\n\n");
    getch();
    main();
}

void barreirafant(int *x, int *y,int antgx,int antgy,int barra[21][31])
{   int a=*x,b=*y,c;
do{
    if(barra[*x][*y]==1) {*x=antgx;*y=antgy;}
    if(*y==30) *y=0;
    else if(*y==0) *y=30;
    if(a!=*x || b!=*y){
    dirrand(x,y);
      }

 }while(barra[*x][*y]==1);
}
main()
{
    int matriz[21][31];
    char c;
    char b[21][32] ,*a[21];

    int i, j,pis=1, t=50,aux[4],auxy[4], ponto=0, barra[21][31];
    coord pm, fant[3];
    pm.x=18;
    pm.y=1;
for(i=0;i<21;i++) a[i]=b[i];
 a[0]="1111111111111111111111111111111";
 a[1]= "1##############1##############1";
 a[2]="1#11111#111111#1#111111#11111#1";
 a[3] ="1#11111#111111#1#111111#11111#1";
 a[4] ="1#############################1";
 a[5] ="1#111111#11#1111111#11#111111#1";
 a[6] ="1##############1##############1";
 a[7] ="111#1111#11#0000000#11#1111#111";
 a[8] ="111#1111#1101111111011#1111#111";
 a[9] ="111#1111#1101000001011#1111#111";
 a[10]="0##########011111110##########0";
 a[11]="111#1111#1100000000011#1111#111";
 a[12]="111#1111#11#1111111#11#1111#111";
 a[13]="1##############1##############1";
 a[14]="1#111111#11111#1#11111#111111#1";
 a[15]="1######1###############1######1";
 a[16]="111111#1#11111#1#11111#1#111111";
 a[17]="1########11111#1#11111########1";
 a[18]="1#111111111111#1#111111111111#1";
 a[19]="1#############################1";
 a[20]="1111111111111111111111111111111";
    for(i=0;i<21;i++){
        for(j=0;j<31;j++){
            if((a[i][j])=='1')matriz[i][j]=1;
            else if(a[i][j]=='#')matriz[i][j]=2;
            else matriz[i][j]=0;
//printf("%d",matriz[i][j]);

        }//puts(a[i]);

//Sleep(1500);
    }
    for(i=0; i<3; i++)
    {
        fant[i].x=10;
        fant[i].y=15;
    }

    for(i=0; i<21; i++)
        for(j=0; j<31; j++)
            barra[i][j]=0;

    for(i=0; i<21; i++)
    {
        for(j=0; j<31; j++)
        {

            if(matriz[i][j]==1)
                matriz[i][j]=219;
            else if( matriz[i][j]==0)
                matriz[i][j]=' ';
            else  matriz[i][j]=248;
            if(matriz[i][j]==219) barra[i][j]=1;

        }
    }
    matriz[pm.x][pm.y]=' ';

    while(1)
    {
        system("cls");

        for(i=0; i<3; i++)
        {
            auxy[i]=fant[i].y;
            aux[i]=fant[i].x;
            dirrand(&fant[i].x, &fant[i].y);
            barreirafant(&fant[i].x,&fant[i].y,aux[i],auxy[i],barra);
            if(fant[i].x==pm.x && fant[i].y==pm.y)
            {
                GAMEOVER();
            }
        }

        auxy[3]=pm.y;
        aux[3]=pm.x;
        direcao(&pm.x, &pm.y);
        barreira(&pm.x,&pm.y,aux[3],auxy[3],barra);



        printf("Pontuacao: %d\n", ponto);
        for(i=0; i<21; i++)
        {
            for(j=0; j<31; j++)
            {

                if( matriz[i][j]==248 && i==pm.x && j==pm.y)
                {
                    ponto++;
                    t=250;
                    matriz[i][j]=' ';
                   if(pis%2==0){putchar('C');
                    }
                    else putchar('O');
                }
                else if( matriz[i][j]==' ' && i==pm.x && j==pm.y)
                {
                    t=0;
                    if(pis%2==0){putchar('C');
                    }
                    else putchar('O');
                }

                //if(i==pm.x&&j==pm.y) matriz[i][j]='O';
                else if(i==fant[0].x && j==fant[0].y)
                {
                    putchar(182); //fantasma
                }
                else if(i==fant[1].x && j==fant[1].y)
                {
                    putchar(182);//fantasma
                }
                else if(i==fant[2].x && j==fant[2].y)
                {
                    putchar(182);//fantasma
                }
                //else matriz[i][j]=' ';
                else printf("%c", matriz[i][j]);
            }
            putchar('\n');
        }
        for(i=0; i<3; i++)
        {
            if(fant[i].x==pm.x && fant[i].y==pm.y)
            {
                GAMEOVER();
            }
        }
        Sleep(250);pis++;
    }
}
