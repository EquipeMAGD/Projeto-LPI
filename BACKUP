#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
#include <conio.h>
#include <dos.h>



typedef struct coord
{
    int x, y;
} coord;

void barreira(int *x, int *y,int antgx,int antgy,int barra[21][31])
{
    if(barra[*x][*y]==1)
    {
        *x=antgx;
        *y=antgy;
    }
    if(*y==30) *y=0;
    else if(*y==0) *y=30;
    if(*x==0) *x=20;
    else if(*x==20) *x=0;
}

void direcao(int *x, int *y)
{
    static char c;
    if(kbhit()) c=getch();
    switch(c)
    {
    case 'w':
        *x-=1;
        break;
    case 's':
        *x+=1;
        break;
    case 'a':
        *y-=1;
        break;
    case 'd':
        *y+=1;
        break;
    }
}

void dirrand(int *x, int *y)
{
    int n;
    static int cont=0;
    cont++;
    if(cont>12) n=rand()%4;
    else n=0;
    switch(n)
    {
    case 0:
        *x-=1;
        break;
    case 1:
        *x+=1;
        break;
    case 2:
        *y-=1;
        break;
    case 3:
        *y+=1;
        break;
    }
}

void GAMEOVER(int ponto)
{
    char nome[20];
    char rp;

    system("cls");
    printf("\n\n\n\n\n\t\t\tGAME OVER\n\n\n\t\tPrecione qualquer tecla...\n\n");
    getch();

    FILE *file;
    file = fopen("ranking.txt","a");
    printf("\tDigite seu nome..\n\t");
    gets(nome);
    fputs(nome,file);
    fprintf(file," ---  %i", ponto);
    fputc('\n',file);
    fclose(file);
    system("cls");
    printf("\nJOGAR NOVAMENTE?\n");
    rp = getche();

    if(rp=='s' || rp=='S')main();
    else exit(1);
}

void barreirafant(int *x, int *y,int antgx,int antgy,int barra[21][31])
{
    do
    {
        if(barra[*x][*y]==1)
        {
            *x=antgx;
            *y=antgy;
            dirrand(x,y);
        }
        if(*y==30) *y=0;
        else if(*y==0) *y=30;
    }
    while(barra[*x][*y]==1);
}

main()
{
    int matriz[21][31];
    char c;
    char b[21][32],*a[21];

    int i, j,pis=1, t=50,aux[4],auxy[4], ponto=0, barra[21][31];
    coord pm, fant[3];

    //DEFINIÇÃO DE COORDENADAS INICIAIS
    pm.x=11;
    pm.y=15;
    for(i=0; i<3; i++)
    {
        fant[i].x=10;
        fant[i].y=15;
    }

    for(i=0; i<21; i++) a[i]=b[i];
    a[0] ="3111111111111118111111111111114";
    a[1] ="2##############2##############2";
    a[2] ="2#caaad#caaaad#2#caaaad#caaad#2";
    a[3] ="2#faaae#faaaae#2#faaaae#faaae#2";
    a[4] ="2#############################2";
    a[5] ="2#111111#11#1111111#11#111111#2";
    a[6] ="2#############################2";
    a[7] ="714#caad#cd000000000cd#caad#319";
    a[8] ="202#b00b#bb031101140bb#b00b#202";
    a[9] ="715#faae#fe020000020fe#faae#619";
    a[10]="0##########061111150##########0";
    a[11]="714#caad#cd000000000cd#caad#319";
    a[12]="715#faae#fe#1118111#fe#faae#619";
    a[13]="2##############2##############2";
    a[14]="2#111114#11111#2#11111#311111#2";
    a[15]="2######2###############2######2";
    a[16]="711111#2#caaad#1#caaad#2#111119";
    a[17]="2########b000b#1#b000b########2";
    a[18]="2#1111111faaae#1#faaaeaaaaaaa#2";
    a[19]="2#############################2";
    a[20]="6111111111111111111111111111115";

    //DEFINIÇÃO DAS BARREIRAS
    for(i=0; i<21; i++)
    {
        for(j=0; j<31; j++)
        {
            barra[i][j]=0;
            switch(a[i][j])
            {
            //Duas linhas
            case '1': matriz[i][j]=205; break;
            case '2': matriz[i][j]=186; break;
            case '3': matriz[i][j]=201; break;//Quinas
            case '4': matriz[i][j]=187; break;
            case '5': matriz[i][j]=188; break;
            case '6': matriz[i][j]=200; break;
            case '7': matriz[i][j]=204; break;
            case '8': matriz[i][j]=203; break;
            case '9': matriz[i][j]=185; break;

            //Uma linha
            case 'a': matriz[i][j]=196; break;
            case 'b': matriz[i][j]=179; break;
            case 'c': matriz[i][j]=218; break;
            case 'd': matriz[i][j]=191; break;
            case 'e': matriz[i][j]=217; break;
            case 'f': matriz[i][j]=192; break;

            case '#': matriz[i][j]=250; break;
            default: matriz[i][j]=' '; break;
            }
            /*/
            if((a[i][j])=='1') matriz[i][j]=219;
            else if(a[i][j]=='#')matriz[i][j]=250;
            else matriz[i][j]=' ';
            /*/
            if(matriz[i][j]!=250 && matriz[i][j]!=' ') barra[i][j]=1;
        }
    }

    while(1)
    {
        system("cls");

        for(i=0; i<3; i++)
        {
            auxy[i]=fant[i].y;
            aux[i]=fant[i].x;
            dirrand(&fant[i].x, &fant[i].y);
            barreirafant(&fant[i].x,&fant[i].y,aux[i],auxy[i],barra);
            if(fant[i].x==pm.x && fant[i].y==pm.y)
            {
                GAMEOVER(ponto);
            }
        }

        auxy[3]=pm.y;
        aux[3]=pm.x;
        direcao(&pm.x, &pm.y);
        barreira(&pm.x,&pm.y,aux[3],auxy[3],barra);

        printf("Pontuacao: %d\n", ponto);
        for(i=0; i<21; i++)
        {
            for(j=0; j<31; j++)
            {

                if( matriz[i][j]==250 && i==pm.x && j==pm.y)
                {
                    ponto++;
                    matriz[i][j]=' ';
                    if(pis%2==0) putchar('C');
                    else putchar('O');
                }
                else if( matriz[i][j]==' ' && i==pm.x && j==pm.y)
                {
                    if(pis%2==0) putchar('C');
                    else putchar('O');
                }
                else if(i==fant[0].x && j==fant[0].y) putchar(182); //fantasma
                else if(i==fant[1].x && j==fant[1].y) putchar(182); //fantasma
                else if(i==fant[2].x && j==fant[2].y) putchar(182); //fantasma
                else printf("%c", matriz[i][j]);
            }
            putchar('\n');
        }
        for(i=0; i<3; i++)
        {
            if(fant[i].x==pm.x && fant[i].y==pm.y)
            {
                GAMEOVER(ponto);
            }
        }
        Sleep(250);
        pis++;
    }
}
